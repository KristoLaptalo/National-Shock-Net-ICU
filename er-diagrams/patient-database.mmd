erDiagram
    %% ============================================================================
    %% NATIONAL SHOCK REGISTRY - DATABASE SCHEMA
    %% ============================================================================
    %%
    %% Architecture:
    %%   - INFRASTRUCTURE: Hospital, Subscription, ICU Units, Staff
    %%   - ANONYMIZATION LAYER: Active Tracking (TT) → Registry Archive (AID)
    %%   - CLINICAL DATA: Linked to tracking via TT during active phase
    %%
    %% Privacy Model:
    %%   - TT (Tracking Token): Temporary, destroyed on archive
    %%   - AID (Archive ID): Generated at archive time, permanent
    %%   - Registry ID: Human-readable (NSN-XXXX-XXXX-XXXX) for Decursus Morbi
    %%   - No cloud mapping: Re-identification only possible at hospital
    %%
    %% ============================================================================

    %% ============================================================================
    %% SECTION 1: HOSPITAL INFRASTRUCTURE
    %% ============================================================================

    HOSPITAL ||--o| ICU_SUBSCRIPTION : has
    HOSPITAL ||--o{ ICU_UNIT : operates
    HOSPITAL ||--o{ PHYSICIAN : employs
    HOSPITAL {
        int hospital_id PK
        string name
        string city
        string region
        string address
        string phone
        string type
        boolean is_active
    }

    ICU_SUBSCRIPTION {
        int subscription_id PK
        int hospital_id FK
        string subscription_tier
        date start_date
        date end_date
        boolean is_active
        int max_beds
        int max_monthly_submissions
        string contract_number UK
    }

    ICU_UNIT {
        int icu_id PK
        int hospital_id FK
        string name
        string type
        int total_beds
        boolean is_active
    }

    PHYSICIAN {
        int physician_id PK
        int hospital_id FK
        string first_name
        string last_name
        string specialty
        string license_number UK
        string email
        string app_role
    }

    ADMIN_USER {
        int admin_id PK
        string username UK
        string password_hash
        string first_name
        string last_name
        string role
        string email UK
        boolean is_active
    }

    %% ============================================================================
    %% SECTION 2: ANONYMIZATION LAYER (Privacy-Preserving)
    %% ============================================================================
    %%
    %% Flow: ACTIVE_TRACKING --[archive]--> REGISTRY_ARCHIVE
    %%       TT destroyed ←──────────────→ AID + Registry ID created
    %%
    %% ============================================================================

    HOSPITAL ||--o{ ACTIVE_TRACKING : creates
    ICU_SUBSCRIPTION ||--o{ ACTIVE_TRACKING : allows
    ACTIVE_TRACKING ||--o| REGISTRY_ARCHIVE : archives_to

    ACTIVE_TRACKING {
        uuid tt PK "Tracking Token (temporary)"
        int hospital_id FK
        int subscription_id FK
        datetime created_at
        datetime updated_at
        datetime expires_at
        datetime closed_at
        string status "active|closed"
        string shock_type "cardiogenic|septic|..."
        string scai_stage "A|B|C|D|E"
        int age_decade "Anonymized: 0-110"
        char sex "M|F|U"
        jsonb admission_data "Validated, no PII"
        jsonb hemodynamics "Time-series array"
        jsonb laboratory "Time-series array"
        jsonb ventilation "Time-series array"
        jsonb medications "Array"
        jsonb procedures "Array"
        jsonb notes "Array"
        string outcome_status "Required before archive"
        jsonb outcome_data
    }

    REGISTRY_ARCHIVE {
        uuid aid PK "Archive ID (generated at archive)"
        string registry_id UK "NSN-XXXX-XXXX-XXXX"
        datetime archived_at
        int archive_version
        string hospital_region "Anonymized region only"
        string shock_type
        string scai_stage_admission
        string scai_stage_worst
        int age_decade
        char sex
        jsonb aggregated_data "No timestamps, summarized"
        string outcome_status
        int length_of_stay_days
        int icu_days
        jsonb cohort_flags "Research categorization"
        string data_checksum "SHA-256 integrity"
    }

    ANON_AUDIT_LOG {
        bigint id PK
        datetime event_time
        string event_type "created|accessed|archived|purged"
        string actor_role
        uuid actor_id
        uuid aid "Only after archive, NEVER TT"
        string registry_id
        inet ip_address
        string user_agent
        jsonb metadata
    }

    %% ============================================================================
    %% SECTION 3: LEGACY PATIENT MODEL (For Reference)
    %% ============================================================================
    %%
    %% NOTE: This section shows the original patient-centric model.
    %% In the new privacy architecture, ACTIVE_TRACKING replaces PATIENT
    %% for the cloud database. Patient identity exists ONLY at hospital.
    %%
    %% ============================================================================

    PATIENT ||--o{ ADMISSION : has
    PATIENT {
        int patient_id PK "Hospital-only"
        string patient_code UK "Legacy pseudonym"
        string qr_code UK "Legacy QR"
        string encrypted_identity "AES-256 - REMOVED in new model"
        string national_id_hash "SHA-256 - REMOVED in new model"
        date date_of_birth "Hospital-only"
        int age
        string gender
        decimal weight_kg
        decimal height_cm
        decimal bsa
        decimal bmi
    }

    ICU_SUBSCRIPTION ||--o{ ADMISSION : allows
    PHYSICIAN ||--o{ ADMISSION : submits
    ADMIN_USER ||--o{ ADMISSION : approves
    ADMISSION ||--|| OUTCOME : results_in
    ADMISSION {
        int admission_id PK "Hospital-only"
        int patient_id FK
        int subscription_id FK
        int icu_id FK
        int physician_id FK
        int approved_by FK
        string case_number UK
        uuid tracking_token "Links to cloud TT"
        string registry_id "After archive: NSN-XXXX"
        date date_of_admission
        date date_of_shock_onset
        int point_of_referral
        string referral_hospital
        datetime submission_date
        datetime admission_date
        string status
        string bed_number
    }

    OUTCOME {
        int outcome_id PK
        int admission_id FK
        boolean died_in_icu
        int transfer_type
        date icu_discharge_date
        boolean died_in_hospital
        date inhospital_death_date
        int discharge_destination
        date hospital_discharge_date
        int length_of_stay_icu
        int length_of_stay_hospital
    }

    %% ============================================================================
    %% SECTION 4: CLINICAL DATA (Linked to ACTIVE_TRACKING via TT)
    %% ============================================================================
    %%
    %% In cloud: stored as JSONB arrays in ACTIVE_TRACKING
    %% At hospital: can be stored in normalized tables linked to ADMISSION
    %%
    %% ============================================================================

    ADMISSION ||--|| MEDICAL_HISTORY : has
    MEDICAL_HISTORY {
        int history_id PK
        int admission_id FK
        int cad
        int prior_revasc
        int prior_mi
        int chronic_hf
        int valvular_disease
        int atrial_fib
        int pacemaker
        int cerebrovascular
        int prior_tia
        int hemiplegia
        int diabetes
        int hypertension
        int dyslipidemia
        int liver_disease
        int pad
        int ckd
        int dementia
        int psychiatric
        int pulmonary_disease
        int pulmonary_htn
        int connective_tissue
        int autoimmune
        int adiposity
        int gastric_disorder
        int leukemia
        int lymphoma
        int solid_tumor
        int hiv_aids
        int charlson_index
    }

    ADMISSION ||--|| WORKING_DIAGNOSIS : has
    WORKING_DIAGNOSIS {
        int diagnosis_id PK
        int admission_id FK
        int acs
        int acute_myocarditis
        int heart_failure
        int takotsubo
        int peripartum_cm
        int sepsis
        int pneumonia
        int ards
        int multi_organ_failure
        int acute_aortic
        int electrical_storm
        int pulmonary_embolism
        int trauma_cns
        int polytrauma
        int penetrating_injury
        int other_trauma
        int postpartum_hemorrhage
        int heat_shock
        int dehydration
        int drowning
        int intracerebral_hemorrhage
        int ohca
        int ihca
    }

    ADMISSION ||--|| SHOCK_CLASSIFICATION : has
    SHOCK_CLASSIFICATION {
        int classification_id PK
        int admission_id FK
        boolean cardiogenic
        string scai_stage
        boolean distributive
        string distributive_type
        boolean obstructive
        string obstructive_type
        boolean hypovolemic
        string atls_class
        boolean mixed_shock
        string congestion
        string perfusion
        int sofa_score
    }

    ADMISSION ||--o{ HEMODYNAMIC_DATA : records
    HEMODYNAMIC_DATA {
        int hemo_id PK
        int admission_id FK
        string timepoint
        int nibp_systolic
        int nibp_diastolic
        int nibp_map
        int art_systolic
        int art_diastolic
        int art_map
        int pulse
        string rhythm
        int respiratory_rate
        int spo2
        int etco2
        decimal cvp
        decimal temperature
        string monitor_device
        datetime recorded_at
    }

    ADMISSION ||--o{ ECHOCARDIOGRAPHY : has
    ECHOCARDIOGRAPHY {
        int echo_id PK
        int admission_id FK
        string timepoint
        boolean performed
        int lv_function
        int rv_function
        int lvef
        int lvef_method
        int gls
        int mitral_regurg
        int mitral_stenosis
        int aortic_regurg
        int aortic_stenosis
        int tricuspid_regurg
        int pulmonary_stenosis
        int pulmonary_regurg
        decimal lvot_vti
        decimal lvot_d
        decimal e_wave
        decimal dt_e_wave
        decimal a_wave
        decimal pv_systolic
        decimal pv_diastolic
        decimal tr_vmax
        decimal pf_accel_time
        int ivc_status
        datetime performed_at
    }

    ADMISSION ||--o{ SWAN_GANZ : has
    SWAN_GANZ {
        int sg_id PK
        int admission_id FK
        string timepoint
        boolean performed
        int pcwp
        int spap
        int mpap
        int dpap
        int srvp
        int drvp
        int rap
        decimal co_thermodilution
        decimal co_fick
        decimal cardiac_index
        decimal papi
        datetime performed_at
    }

    ADMISSION ||--o{ BLOOD_GAS : has
    BLOOD_GAS {
        int gas_id PK
        int admission_id FK
        string timepoint
        string sample_type
        string analyzer_model
        decimal ph
        decimal pco2
        decimal po2
        decimal sodium
        decimal potassium
        decimal chloride
        decimal calcium_ionized
        decimal glucose
        decimal lactate
        decimal thb
        decimal o2hb
        decimal cohb
        decimal methb
        decimal hhb
        decimal so2_measured
        decimal tco2
        decimal hco3_actual
        decimal hco3_standard
        decimal be_ecf
        decimal be_blood
        decimal anion_gap
        decimal pf_ratio
        decimal sao2
        decimal scvo2
        decimal svo2
        datetime collected_at
    }

    ADMISSION ||--o{ VENTILATOR_SETTINGS : has
    VENTILATOR_SETTINGS {
        int vent_id PK
        int admission_id FK
        string timepoint
        string device_manufacturer
        string device_model
        string vent_mode
        int fio2
        decimal peep
        decimal ps_above_peep
        decimal pinsp
        decimal ppeak
        decimal pmean
        decimal pplat
        decimal vt_set
        decimal vt_measured
        decimal vte
        int rr_set
        int rr_total
        int rr_spontaneous
        decimal mv_total
        decimal mv_spontaneous
        decimal compliance_static
        decimal compliance_dynamic
        decimal resistance
        int etco2
        datetime recorded_at
    }

    ADMISSION ||--o{ LABORATORY_RESULTS : has
    LABORATORY_RESULTS {
        int lab_id PK
        int admission_id FK
        string timepoint
        datetime collected_at
        decimal rbc
        decimal hemoglobin
        decimal hematocrit
        decimal wbc
        decimal neutrophils_abs
        decimal lymphocytes_abs
        decimal platelets
        decimal pt_inr
        decimal aptt
        decimal fibrinogen
        decimal d_dimer
        decimal bilirubin_total
        decimal ast
        decimal alt
        decimal urea
        decimal creatinine
        decimal egfr
        decimal crp
        decimal procalcitonin
        decimal troponin_i
        decimal bnp
        decimal nt_probnp
    }

    ADMISSION ||--o{ MCS : has
    MCS {
        int mcs_id PK
        int admission_id FK
        int iabp
        int impella_25
        int impella_cp
        int impella_50
        int impella_55
        int impella_rp
        int va_ecmo
        int vv_ecmo
        int ecpella
        int tandemheart
        int lvad
        int rvad
        int bivad
        int tah
        date insertion_date
        int insertion_location
        int access_site
        int indication
        string iabp_ratio
        string impella_p_level
        decimal impella_flow
        decimal ecmo_flow
        int ecmo_rpm
        int ecmo_fio2
        decimal ecmo_sweep
        int complication_bleeding
        int complication_hemolysis
        int complication_limb_ischemia
        int complication_thrombosis
        int complication_stroke
        int complication_infection
        date removal_date
        int removal_reason
    }

    ADMISSION ||--|| PRE_ADMISSION_MEDS : has
    PRE_ADMISSION_MEDS {
        int med_id PK
        int admission_id FK
        int warfarin
        int dabigatran
        int apixaban
        int rivaroxaban
        int edoxaban
        int aspirin
        int clopidogrel
        int ticagrelor
        int prasugrel
        int beta_blocker
        int ace_inhibitor
        int arb
        int arni
        int mra
        int sglt2i
        int furosemide
        int sildenafil
        int flecainide
        int propafenone
        int verapamil_diltiazem
        int amiodarone
        int mexiletine
        int sotalol
        int dronedarone
        int other_antiarrhythmic
        int statin
        int ezetimibe
        int pcsk9i
        int metformin
        int insulin
        int dpp4i
        int pioglitazone
        int sulfonylurea
        int immunomodulator
        int corticosteroid
        int chemotherapy
        int inhaled_therapy
    }

    ADMISSION ||--o{ FOLLOW_UP : tracks
    FOLLOW_UP {
        int followup_id PK
        int admission_id FK
        string timepoint
        datetime recorded_at
        text notes
    }

    %% ============================================================================
    %% SECTION 5: SYSTEM AUDIT (Legacy)
    %% ============================================================================

    AUDIT_LOG {
        int log_id PK
        string table_name
        int record_id
        string action
        json old_values
        json new_values
        int performed_by
        datetime performed_at
        string ip_address
    }
